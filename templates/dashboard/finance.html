{% extends 'base.html' %}
{% load static %}

{% block title %}Gelir/Gider ƒ∞≈ülemleri - Mestakip{% endblock %}
{% block page_name %}finance{% endblock %}

{% block extra_css %}
<style>
    [data-bs-theme=dark] .table th {
        background-color: #182f46 !important;
        border-color: #495057 !important;
        color: #ffffff !important;
    }

    [data-bs-theme=dark] .table-secondary th {
        background-color: #182f46 !important;
    }
</style>
{% endblock %}

{% block content %}


{% if form.errors %}
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    <h5 class="alert-heading"><i class="bi bi-exclamation-triangle me-2"></i>Form Hatalarƒ±</h5>
    {% for field, errors in form.errors.items %}
    {% for error in errors %}
    <p class="mb-1"><strong>{{ field }}:</strong> {{ error }}</p>
    {% endfor %}
    {% endfor %}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

{% if form.non_field_errors %}
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    <h5 class="alert-heading"><i class="bi bi-exclamation-triangle me-2"></i>Hata</h5>
    {% for error in form.non_field_errors %}
    <p class="mb-1">{{ error }}</p>
    {% endfor %}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<form method="post" class="row g-4" id="financeForm">
    {% csrf_token %}
    <input type="hidden" name="next" value="{% url 'dashboard:products' %}">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">ƒ∞≈ülem Bilgileri</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Hareket Tipi</label>
                        {{ form.hareket_tipi }}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Tarih</label>
                        {{ form.tarih }}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Kasa Adƒ±</label>
                        {{ form.kasa_adi }}
                    </div>

                    <div class="col-12 mb-3">
                        <div id="payment-info" class="alert alert-info d-none">
                            <i class="bi bi-info-circle me-2"></i>
                            <span id="payment-info-text">√ñdeme t√ºr√º se√ßildi</span>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">üí∞ Nakit</label>
                        {{ form.nakit }}
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">üí≥ Kredi Kartƒ±</label>
                        {{ form.kredi_karti }}
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">üè¢ Cari</label>
                        {{ form.cari }}
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">üè¶ Mehmet Havale</label>
                        {{ form.mehmet_havale }}
                    </div>

                    <div class="col-12">
                        <label class="form-label">A√ßƒ±klama</label>
                        {{ form.aciklama }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    Kategori
                    <span class="badge bg-info ms-2">{{ ana_kategoriler.count }} ana kategori</span>
                </h5>
            </div>
            <div class="card-body">

                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Ana Kategori Se√ßin (Opsiyonel)</label>
                        <select class="form-select" name="ana_kategori" id="ana-kategori-select">
                            <option value="">Ana Kategori Se√ßiniz</option>
                            {% for kategori in ana_kategoriler %}
                            <option value="{{ kategori.id }}">{{ kategori.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Alt Kategori Se√ßin (Opsiyonel)</label>
                        <select class="form-select" name="kategori1" id="alt-kategori-select" disabled>
                            <option value="">√ñnce ana kategori se√ßin</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 d-flex justify-content-end">
        <button type="submit" class="btn btn-primary">Kaydet</button>
    </div>
</form>

<!-- Excel G√∂mme Alanƒ± Ba≈ülangƒ±√ß -->
<div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
            <i class="bi bi-file-earmark-excel me-2"></i>Excel Dosyasƒ± Y√ºkle ve G√∂r√ºnt√ºle
        </h5>
        <div class="d-flex gap-2">
            <input type="date" id="start-date" class="form-control form-control-sm" placeholder="Ba≈ülangƒ±√ß">
            <input type="date" id="end-date" class="form-control form-control-sm" placeholder="Biti≈ü">
            <button type="button" id="btn-date-filter" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-funnel"></i> Filtrele
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="mb-3">
            <label for="excelFileInput" class="form-label">
                <i class="bi bi-upload me-1"></i>Excel Dosyasƒ± Se√ßin (.xls, .xlsx)
            </label>
            <input type="file" id="excelFileInput" accept=".xls,.xlsx" class="form-control" />
            <div class="form-text">
                Beklenen s√ºtunlar: TARƒ∞H, FATURANO, M√ú≈ûTERƒ∞, √úR√úN, TUTAR, √ñDEME PLANI
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <div id="file-info" class="text-muted small"></div>
            <button type="button" id="btn-excel-save" class="btn btn-success" disabled>
                <i class="bi bi-save me-1"></i>Verileri Kaydet
            </button>
        </div>

        <div id="excel-table-container" class="table-responsive">
            <div class="text-center text-muted py-4">
                <i class="bi bi-file-earmark-excel display-4 d-block mb-2"></i>
                <p>Excel dosyasƒ± se√ßin ve verilerinizi g√∂r√ºnt√ºleyin</p>
            </div>
        </div>
    </div>
</div>
<!-- Excel G√∂mme Alanƒ± Sonu -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const tableContainer = document.getElementById('excel-table-container');
        const fileInput = document.getElementById('excelFileInput');
        const saveBtn = document.getElementById('btn-excel-save');
        let excelData = [];
        let currentExcelFileName = '';
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const dateFilterBtn = document.getElementById('btn-date-filter');
        let allRows = [];

        // Excel ba≈ülƒ±ƒüƒ± => G√∂sterilecek ba≈ülƒ±k e≈üle≈ümesi
        const columns = [
            { source: "TARƒ∞H", label: "TARƒ∞H" },
            { source: "FATURANO", label: "FATURANO" },
            { source: "M√ú≈ûTERƒ∞", label: "M√ú≈ûTERƒ∞" },
            { source: "√úR√úN", label: "√úR√úN" },
            { source: "TUTAR", label: "TUTAR" },
            { source: "√ñDEME PLANI", label: "√ñDEME PLANI" }
        ];

        function excelDateToString(serial) {
            if (!serial) return "";
            if (typeof serial === "string" && serial.includes(".")) return serial;
            var utc_days = Math.floor(serial - 25569);
            var utc_value = utc_days * 86400;
            var date_info = new Date(utc_value * 1000);
            var d = date_info.getUTCDate();
            var m = date_info.getUTCMonth() + 1;
            var y = date_info.getUTCFullYear();
            return `${(d < 10 ? '0' : '') + d}.${(m < 10 ? '0' : '') + m}.${y}`;
        }

        function isRowInDateRange(row, start, end) {
            let val = row['TARƒ∞H'];
            if (typeof val === 'number') val = excelDateToString(val);
            if (!/\d{2}\.\d{2}\.\d{4}/.test(val)) return true; // filtreye dahil, tarihi yok veya formatƒ± yanlƒ±≈üsa
            const [gun, ay, yil] = val.split('.');
            const rowDate = new Date(`${yil}-${ay}-${gun}`);
            if (start && rowDate < start) return false;
            if (end && rowDate > end) return false;
            return true;
        }

        function renderTable(data) {
            excelData = data; // save for backend
            if (!data.length) {
                tableContainer.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-exclamation-circle display-4 d-block mb-2"></i>
                        <p>Tablo verisi bulunamadƒ±.</p>
                    </div>`;
                return;
            }

            // Dosya bilgisini g√ºncelle
            document.getElementById('file-info').innerHTML = `
                <i class="bi bi-file-earmark-excel me-1"></i>
                <strong>${currentExcelFileName}</strong> - ${data.length} kayƒ±t
            `;

            let table = `
                <table class="table table-bordered table-striped table-hover table-dark">
                    <thead class="table-secondary">
                        <tr>`;

            // Sadece mevcut s√ºtunlarƒ± g√∂ster - her label i√ßin sadece bir tane al
            const availableColumns = [];
            const usedLabels = new Set();

            for (const col of columns) {
                if (!usedLabels.has(col.label) && data.some(row => row.hasOwnProperty(col.source))) {
                    availableColumns.push(col);
                    usedLabels.add(col.label);
                }
            }

            availableColumns.forEach(col => table += `<th class="text-center">${col.label}</th>`);
            table += `</tr></thead><tbody>`;

            data.forEach((row, index) => {
                table += `<tr>`;
                availableColumns.forEach(col => {
                    let cell = row[col.source] ?? '';

                    // Tarihi d√ºzelt
                    if (col.label === "TARƒ∞H") {
                        cell = (typeof cell === "number")
                            ? excelDateToString(cell)
                            : cell;
                        cell = `<span class="badge bg-primary">${cell}</span>`;
                    }

                    // TUTAR i√ßin: Orijinal deƒüeri koru, sadece stil ekle
                    if (col.label === "TUTAR") {
                        // Orijinal deƒüeri olduƒüu gibi g√∂ster, sadece stil ekle
                        cell = `<span class="text-warning fw-bold">${cell}</span>`;
                    }

                    // FATURANO i√ßin: Orijinal deƒüeri koru
                    if (col.label === "FATURANO") {
                        cell = `<code class="text-info">${cell}</code>`;
                    }

                    // M√ú≈ûTERƒ∞ i√ßin
                    if (col.label === "M√ú≈ûTERƒ∞") {
                        cell = `<span class="fw-semibold text-light">${cell}</span>`;
                    }

                    // √ñDEME PLANI i√ßin
                    if (col.label === "√ñDEME PLANI") {
                        const badgeClass = cell.toLowerCase().includes('nakit') ? 'bg-success' :
                            cell.toLowerCase().includes('kart') ? 'bg-primary' :
                                cell.toLowerCase().includes('havale') ? 'bg-warning' : 'bg-secondary';
                        cell = `<span class="badge ${badgeClass}">${cell}</span>`;
                    }

                    table += `<td class="text-center">${cell}</td>`;
                });
                table += `</tr>`;
            });
            table += '</tbody></table>';
            tableContainer.innerHTML = table;
        }

        function filterAndRender() {
            let start = startDateInput.value ? new Date(startDateInput.value) : null;
            let end = endDateInput.value ? new Date(endDateInput.value) : null;
            if (end) { end.setHours(23, 59, 59, 999); } // tam g√ºn kapsasƒ±n
            if (!start && !end) return renderTable(allRows);
            renderTable(allRows.filter(r => isRowInDateRange(r, start, end)));
        }

        fileInput.addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) {
                document.getElementById('btn-excel-save').disabled = true;
                document.getElementById('file-info').innerHTML = '';
                return;
            }

            currentExcelFileName = file.name;
            document.getElementById('file-info').innerHTML = `
                <i class="bi bi-hourglass-split me-1"></i>
                <span class="text-warning">Dosya y√ºkleniyor...</span>
            `;

            const reader = new FileReader();
            reader.onload = function (event) {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    // Excel'i ham veri olarak oku, formatƒ± koru
                    const range = XLSX.utils.decode_range(worksheet['!ref']);
                    const headers = [];

                    // Ba≈ülƒ±klarƒ± al
                    for (let col = range.s.c; col <= range.e.c; col++) {
                        const cellAddress = XLSX.utils.encode_cell({ r: range.s.r, c: col });
                        const cell = worksheet[cellAddress];
                        if (cell && cell.v) {
                            headers.push(cell.v.toString().trim());
                        }
                    }

                    // Verileri ham h√ºcre deƒüerleriyle olu≈ütur
                    let json = [];
                    for (let row = range.s.r + 1; row <= range.e.r; row++) {
                        const rowData = {};
                        for (let col = range.s.c; col <= range.e.c; col++) {
                            const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                            const cell = worksheet[cellAddress];
                            const header = headers[col - range.s.c];

                            if (cell) {
                                // Formatlanmƒ±≈ü deƒüeri kullan (w: formatlanmƒ±≈ü metin, v: ham deƒüer)
                                rowData[header] = cell.w || cell.v || '';
                            } else {
                                rowData[header] = '';
                            }
                        }
                        if (Object.keys(rowData).some(key => rowData[key] !== '')) {
                            json.push(rowData);
                        }
                    }

                    // Ba≈ülƒ±klarƒ± normalize et - SADECE ba≈ülƒ±k adlarƒ±nƒ± d√ºzelt, deƒüerleri olduƒüu gibi koru
                    json = json.map(row => {
                        let fixed = {};
                        Object.keys(row).forEach(key => {
                            let normalizedKey = key.trim().toUpperCase().replace(/\s+/g, ' ');

                            // Ba≈ülƒ±k e≈üle≈ümeleri - sadece ba≈ülƒ±k adƒ±nƒ± deƒüi≈ütir, deƒüeri koru
                            if (normalizedKey === 'FATURA NO' || normalizedKey === 'FATURANO') {
                                normalizedKey = 'FATURANO';
                            } else if (normalizedKey.includes('M√ú≈ûTERI') || normalizedKey.includes('M√ú≈ûTERƒ∞')) {
                                normalizedKey = 'M√ú≈ûTERƒ∞';
                            } else if (normalizedKey.includes('√úR√úN') || normalizedKey.includes('URUN')) {
                                normalizedKey = '√úR√úN';
                            } else if (normalizedKey === 'TUTAR' || normalizedKey === 'MIKTAR') {
                                normalizedKey = 'TUTAR';
                            } else if (normalizedKey.includes('√ñDEME') || normalizedKey.includes('ODEME')) {
                                normalizedKey = '√ñDEME PLANI';
                            } else if (normalizedKey.includes('TARƒ∞H') || normalizedKey.includes('TARIH')) {
                                normalizedKey = 'TARƒ∞H';
                            }

                            // Orijinal deƒüeri koru
                            fixed[normalizedKey] = row[key];
                        });
                        return fixed;
                    });

                    allRows = json;
                    document.getElementById('btn-excel-save').disabled = false;
                    filterAndRender();

                    // Ba≈üarƒ± mesajƒ±
                    const successAlert = document.createElement('div');
                    successAlert.className = 'alert alert-success alert-dismissible fade show';
                    successAlert.innerHTML = `
                        <i class="bi bi-check-circle me-2"></i>
                        Excel dosyasƒ± ba≈üarƒ±yla y√ºklendi! ${json.length} kayƒ±t bulundu.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    tableContainer.parentNode.insertBefore(successAlert, tableContainer);

                } catch (error) {
                    console.error('Excel okuma hatasƒ±:', error);
                    document.getElementById('file-info').innerHTML = `
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        <span class="text-danger">Dosya okunamadƒ±</span>
                    `;

                    const errorAlert = document.createElement('div');
                    errorAlert.className = 'alert alert-danger alert-dismissible fade show';
                    errorAlert.innerHTML = `
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Excel dosyasƒ± okunamadƒ±. L√ºtfen ge√ßerli bir .xls veya .xlsx dosyasƒ± se√ßin.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    tableContainer.parentNode.insertBefore(errorAlert, tableContainer);
                }
            };
            reader.readAsArrayBuffer(file);
        });
        dateFilterBtn.addEventListener('click', filterAndRender);

        document.getElementById('btn-excel-save').addEventListener('click', function () {
            if (!excelData.length) {
                alert('√ñnce bir Excel dosyasƒ± y√ºkleyin!');
                return;
            }

            const saveBtn = this;
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Kaydediliyor...';

            // Debug: G√∂nderilecek veriyi kontrol et
            console.log('G√∂nderilecek dosya adƒ±:', currentExcelFileName);
            console.log('G√∂nderilecek veri sayƒ±sƒ±:', excelData.length);
            console.log('ƒ∞lk 3 kayƒ±t:', excelData.slice(0, 3));

            // Veri boyutunu kontrol et
            const dataSize = JSON.stringify({ filename: currentExcelFileName, rows: excelData }).length;
            console.log('G√∂nderilecek veri boyutu:', dataSize, 'bytes');

            if (dataSize > 10 * 1024 * 1024) { // 10MB
                alert('Excel dosyasƒ± √ßok b√ºy√ºk. L√ºtfen daha k√º√ß√ºk bir dosya se√ßin.');
                saveBtn.innerHTML = '<i class="bi bi-save me-1"></i>Verileri Kaydet';
                saveBtn.disabled = false;
                return;
            }

            // ƒ∞lk kayƒ±ttaki s√ºtunlarƒ± kontrol et
            if (excelData.length > 0) {
                console.log('ƒ∞lk kayƒ±t s√ºtunlarƒ±:', Object.keys(excelData[0]));
                console.log('ƒ∞lk kayƒ±t deƒüerleri:', Object.values(excelData[0]));
                console.log('ƒ∞lk kayƒ±t tam veri:', excelData[0]);

                // Beklenen s√ºtunlarƒ± kontrol et
                const expectedColumns = ['TARƒ∞H', 'FATURANO', 'M√ú≈ûTERƒ∞', '√úR√úN', 'TUTAR', '√ñDEME PLANI'];
                const actualColumns = Object.keys(excelData[0]);
                console.log('Beklenen s√ºtunlar:', expectedColumns);
                console.log('Mevcut s√ºtunlar:', actualColumns);

                const missingColumns = expectedColumns.filter(col => !actualColumns.includes(col));
                if (missingColumns.length > 0) {
                    console.warn('Eksik s√ºtunlar:', missingColumns);
                }
            }

            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            fetch('/dashboard/malzeme-excel-kaydet/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    filename: currentExcelFileName,
                    rows: excelData
                })
            })
                .then(resp => {
                    console.log('Response status:', resp.status);
                    return resp.json().then(data => {
                        console.log('Response data:', data);
                        if (!resp.ok) {
                            throw new Error(`HTTP ${resp.status}: ${data.error || resp.statusText}`);
                        }
                        return data;
                    });
                })
                .then(data => {
                    if (data.success) {
                        saveBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Ba≈üarƒ±yla Kaydedildi';
                        saveBtn.className = 'btn btn-success';

                        // Ba≈üarƒ± mesajƒ± g√∂ster
                        let successMessage = `<strong>Ba≈üarƒ±lƒ±!</strong> ${data.count || excelData.length} kayƒ±t veritabanƒ±na eklendi.`;
                        if (data.warnings) {
                            successMessage += `<br><small class="text-warning">${data.warnings}</small>`;
                        }

                        const successAlert = document.createElement('div');
                        successAlert.className = 'alert alert-success alert-dismissible fade show';
                        successAlert.innerHTML = `
                            <i class="bi bi-check-circle me-2"></i>
                            ${successMessage}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                        tableContainer.parentNode.insertBefore(successAlert, tableContainer);

                        // Uyarƒ±lar varsa g√∂ster
                        if (data.errors && data.errors.length > 0) {
                            const warningAlert = document.createElement('div');
                            warningAlert.className = 'alert alert-warning alert-dismissible fade show mt-2';
                            warningAlert.innerHTML = `
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>Bazƒ± satƒ±rlarda sorun:</strong>
                                <ul class="mb-0 mt-2">
                                    ${data.errors.map(err => `<li><small>${err}</small></li>`).join('')}
                                </ul>
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            `;
                            tableContainer.parentNode.insertBefore(warningAlert, tableContainer);
                        }

                        // 3 saniye sonra products sayfasƒ±na y√∂nlendir
                        setTimeout(() => {
                            window.location.href = '/dashboard/products/';
                        }, 3000);
                    } else {
                        const errorAlert = document.createElement('div');
                        errorAlert.className = 'alert alert-danger alert-dismissible fade show';
                        errorAlert.innerHTML = `
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Hata!</strong> ${data.error || 'Kayƒ±t sƒ±rasƒ±nda bir hata olu≈ütu.'}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                        tableContainer.parentNode.insertBefore(errorAlert, tableContainer);

                        saveBtn.innerHTML = '<i class="bi bi-save me-1"></i>Verileri Kaydet';
                        saveBtn.className = 'btn btn-success';
                        saveBtn.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Kayƒ±t hatasƒ±:', error);

                    // Detaylƒ± hata mesajƒ±
                    let errorMessage = 'Sunucuya baƒülanƒ±lamadƒ±. L√ºtfen tekrar deneyin.';
                    if (error.message.includes('HTTP 400')) {
                        errorMessage = 'Excel verilerinde hata var. L√ºtfen dosya formatƒ±nƒ± kontrol edin.';
                    } else if (error.message.includes('HTTP 500')) {
                        errorMessage = 'Sunucu hatasƒ±. L√ºtfen daha sonra tekrar deneyin.';
                    }

                    const errorAlert = document.createElement('div');
                    errorAlert.className = 'alert alert-danger alert-dismissible fade show';
                    errorAlert.innerHTML = `
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Hata!</strong> ${errorMessage}
                        <br><small>Detay: ${error.message}</small>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    tableContainer.parentNode.insertBefore(errorAlert, tableContainer);

                    saveBtn.innerHTML = '<i class="bi bi-save me-1"></i>Verileri Kaydet';
                    saveBtn.className = 'btn btn-success';
                    saveBtn.disabled = false;
                });
        });
    });
</script>
{% endblock %}